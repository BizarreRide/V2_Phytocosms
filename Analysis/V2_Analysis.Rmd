
V2_Phytocosm_Experiment
========================================================
author: "Quentin Schorpp"
e-mail: quentin.schorpp@ti.bund.de
date: "Tuesday, October 21, 2014"
output: html_document


This is the Analysis of a Phytocosm experiment performed by Valentina Sandor at the Thünen Institute of Biodiverstity in the TIme between September 2013 and August 2014. The Experiment aimed to reveal the effect of *Lumbricus terrestris* (Annelida) and *Folsomia candida* (Collembola) on plant available nutrients in the soil and microbial biomass during growth of *Silphium perfoliatum* and *Cea mays*. The study experiment was conducted twice, first with sandy soil and then again with loamy soil.The duration of both experimental units was 42 days.
Start of experimental Unit 1 (Sandy soil): 01.11.2013; End: 22.12.2014
Start of experimental Unit 2 (Loamy soil): 21.03.2014; End: 02.05.2014

#### Set working directory
```{r set working directory}
# setwd("E:/Quentin Schorpp_17.10.2014/Arbeitsprozess/V2_Analysis")
setwd("C:/Users/Quentin/Documents/V2_Analysis")
# here it is important, that you change this path:
# go to the folder were you put the data in and click in the address line to copy YOUR path
# alternatively you can use :
# setwd(choose.dir())
```

#### Load required packages
```{r packages, warning=FALSE, message=FALSE}
library(ggplot2)
library(reshape2)
library(plyr)
library(MethComp)
library(agricolae)
library(foreign)
library(multcomp)
library(gridExtra)
library(extrafont)
library(effects)
library(MASS)
library(bbmle)
library(splitstackshape)
library(lme4)
````
#### Function for Standard error
```{r Function - Standard error}
se <- function(x) sqrt(var(x)/length(x))
```

##### ggplot2 - Theme
```{r Mytheme}
mytheme = 
  theme_bw() + 
  theme(strip.background = element_rect(color = "light grey", fill="black", size=0.1),
        strip.text.x = element_text(size=8,  colour="white", face="italic"),
        strip.text.y = element_text(size=8,  colour="white", face="italic"),
        axis.text.x = element_text(size=7),
        axis.title.x = element_text(size=8,face="bold", family="Times New Roman"),
        axis.text.y = element_text(size=7),
        axis.title.y = element_text(size=8,face="bold", family="Times New Roman"),
        axis.line = element_line(size=0.25),
        axis.ticks = element_line(size=0.25),
        plot.title = element_text(size=11,face="bold", family="Times New Roman"),
        panel.margin = unit(0, "lines"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(colour="black", size=0.2, fill=NA))
```


#### load datasets
```{r Data}
index<- read.delim("V2_index.txt")
Lt.bm.loam <- read.delim("V2_Lt_bm_loam.txt")
Lt.bm <- read.delim("V2_Lt_bm.txt")
col.pop <- read.delim("V2_col.txt")
pH <- read.delim("V2_pH.txt")
CN <- read.delim("V2_CN.txt")
roots <- read.delim("V2_roots.txt")
shoots <- read.delim("V2_shoots.txt")
cmic <- read.delim("V2_cmic.txt")
leaching <- read.delim("V2_Leaching.txt")
```

Index
```{r Index}
index$plant <- revalue(index$plant, c(Sp ="italic(S.~perfoliatum)",Zm="italic(Z.~mays)"))
index$soil <- revalue(index$soil, c(loam ="Loam",sand="Sand"))
index$Lt <- as.factor(index$Lt)
index$Fc <- as.factor(index$Fc)
```


# L. terrestris survival rate and biomass

## Survival rate:
#### In the sandy soil experiment 6  out of 40 worms died in 3 Phytocosms  
#### survival rate sand: `r 100*(1 - 6/40)`%  
#### In the loamy soil experiment overall out of 41 out of 78 worms survived the experiment.   
#### survival rate loam: `r 100*(41/78)`%  

## Loamy soil only
Here it is a bit difficult, because many worms died at different timepoints during the loamy soil experiment, due to extreme temperatures. And we don't know, which worm was replaced, therfore its impossible to calculate the true total biomass after replacement of any worm. But for maitainig the earthwrom-effect it was inevitably necessary to replace the worms.

The dataset: 
The data set has different responses, all of which were calculated using the individual worm weights, not the total biomass per Phytocosm. first and easiest ist Lt.ind.mean, this is simply the difference in mean individual weights of worms taken out from mean individual weights of worms given in. Because we simply can't differentiate between worms, we can#t exactly say, which worm gained weight on which one lost. Therfore, i calculated all possible differences between worms taken out and those given in. Based on these differences i calculated the ratio between weight gain (positive) and weight loss (negative). Here zero means only losses, Inf only gains and 1 same counts for both (neutral). Another reponse is the calculated probaility of getting only weight gain by drawing wihtout return. Then there is a factor of three levels (positive, neutral and negative), for ratios above and beyond 1. Last but not least there is the means in all possible differences.

The Analysis:
The procedure is to formulate the model for ANOVA and then validate the model, i.e. to check if the assumptions of ANOVA are violated or not. To visualize the significant effects from the ANOVA table we use Boxplots.

```{r L. terrestris Biomass - Loam only}
Lt.bm.loam.aov <- lbl.aov1 <- aov(pos.diff.mean ~ plant*treat, data=Lt.bm.loam) ; summary(lbl.aov1)
par(mfrow=c(2,2))
plot(lbl.aov1)
fligner.test(pos.diff.mean ~ interaction(plant,treat), data=Lt.bm.loam) 
# performs Fligner-Killeen (median) test of homogeneity of variances, to test if there is significant violence of homoscedasticity in each of the groups. If this test has a not significant p-value, there is no clue for violence of this assumption in ANOVA. We could have performed bartlett test, but this is more a test of non-normality. 
# --> p=0.58 our ANOVA is good, and we do not need to transform the response.

lbl.aov2 <- aov(pos.prob ~ plant*treat, data=Lt.bm.loam) 
fligner.test(pos.prob ~ interaction(plant,treat), data=Lt.bm.loam) 
# here the model is not adequate!!
lbl.aov2 <- update(lbl.aov2, sqrt(pos.prob)~.); summary(lbl.aov2)
with(Lt.bm.loam, histogram(sqrt(pos.prob)))
par(mfrow=c(2,2))
plot(lbl.aov2) 
# Ok, here its too much effort to find out how to handle response variables of class "probabilities",... validation plots don't look too bad, so i'll let it be


boxplot(pos.diff.mean ~ plant, 
        data=Lt.bm.loam, col="light blue", las=1, par(mfrow=c(1,1)),
        main = expression(paste("Means of all possible differences for ", italic("L. terrestris"), "`in` vs. `out`")),
        ylab = expression(paste("Difference of ", italic("L. terrestris"), "before/after [g]")),
        names=c(expression(italic("S. perfoliatum"),italic("Z. mays")))
        )
text(x=c(1,2),y=min(boxplot.stats(Lt.bm.loam$pos.diff.mean)$stat), round(with(Lt.bm.loam, data.frame(tapply(pos.prob, plant, mean)))[,1],2), pos=3, offset=-1, cex=.8, col="red")
text(x=1-0.34,y=min(boxplot.stats(Lt.bm.loam$pos.diff.mean)$stat), paste("Probability of getting\nonly weight gain\nin worms taken out"), pos=3, offset=-1.6, cex=.8)

# from the above analysis we get secure evidence, that earthworms are likely to have better growth conditions in S. perfoliatum phytocosms, wether this is due to higher quality nutrition of Silphie litter, or lower energy cost while moving inside of these microcosms (decreased bulk densitiy due to Silphie roots?), is to discuss.

lbl.aov3 <- aov(ind.bm.mean ~ plant*treat, data=Lt.bm.loam); summary(lbl.aov3)
par(mfrow=c(2,2))
plot(lbl.aov3)
fligner.test(ind.bm.mean ~ interaction(plant,treat), data=Lt.bm.loam)

boxplot(ind.bm.mean ~ plant, 
        data=Lt.bm.loam, col="light blue", las=1, par(mfrow=c(1,1)),
        main = expression(paste("Means of individual ", italic("L. terrestris"), "`in` vs. `out`")),
        ylab = expression(paste("mean individual weight before/after [g]")),
        names=c(expression(italic("S. perfoliatum"),italic("Z. mays")))
        )
with(Lt.bm.loam, data.frame(tapply(ind.bm.mean, plant, mean)))
with(Lt.bm.loam, data.frame(tapply(ind.bm.mean, plant, se)))

# from ANOVA we get a significant difference in earthworm mean individual weight of L. terrestris for plant species (ANOVA; F=7.8; p=0.01). In phytocosm

#These responses didn't work in ANOVA:
#summary(aov(pos.diff.ratio ~ plant*treat, data=Lt.bm.loam))
#summary(aov(pos.diff.fac ~ plant*treat, data=Lt.bm.loam))
```

### Reporting results:
### Biomass change of average indivuals of L. terrestris differed signficantly between Phytocosms with S. perfoliatu and Z. mays (ANOVA; F=7.8;p=0.01). During the experiment mean individual biomass increased for 0.41 +/- 0.14 g from XX to XX in Phytocosms with S. perfoliatum, whereas in presence of Z. mays biomass decreased for 0.16 +/- 0.14 g from XX g to XX g. 

## Loamy and sandy soil texture gathered together

from above we learned, that we can trust the results by using the average individual weights of L. terrestris. Therefore I produced a dataset with the average individuals weights for all worms from both, the loamy and the sandy soil experiment. 
The dataset consists of the mean individual weights of all worms given in (before) and all those taken out (after) as well as the differences between after and before.

```{r L. terrestris Biomass}
which(Lt.bm$Lt.bm.diff==0)
Lt.bm.aov1 <- aov(Lt.bm.diff~plant*Lt*Fc*soil, Lt.bm[-c(21,30,33),]); summary(Lt.bm.aov1)
par(mfrow=c(2,2))
plot(Lt.bm.aov1)
fligner.test(Lt.bm.diff~interaction(plant,Lt,Fc,soil), Lt.bm[-c(21,30,33),])
# Model is valid!

boxplot(Lt.bm.diff ~ plant, 
        data=Lt.bm[-c(21,30,33),], col="light blue", las=1, par(mfrow=c(1,1)),
        main = expression(paste("Difference in means of individual ", italic("L. terrestris"), "`out` vs. `in`")),
        ylab = expression(paste("biomass change [g]")),
        names=c(expression(italic("S. perfoliatum"),italic("Z. mays")))
        )
with(Lt.bm[-c(21,30,33),], data.frame(Diff.Mean = tapply(Lt.bm.diff, plant, mean),
                       Diff.SE = tapply(Lt.bm.diff, plant, se),
                       Before.Mean = tapply(Lt.bm.before, plant, mean),
                       Before.SE = tapply(Lt.bm.before, plant, se),
                       After.Mean = tapply(Lt.bm.after, plant, mean),
                       After.SE = tapply(Lt.bm.after, plant, se)))

```

### Reporting Results:
### Biomass change of an average individual of *L. terrestris* was only affected by plant species (ANOVA; F(1,29)=24.5;p<0.001). In Phytocosms with *S. perfoliatum* mean biomass of *L. terrestris*  increased for 0.5 +/- 0.08g from 3.03 +/- 0.03 to 3.52 +/- 0.09 , whereas in presence of Z. mays biomass decreased for 0.11 +/- 0.08 g from 3.13 +/- 0.03 to 3.02 +/- 0.1. 

# Collembolan population
At the beginning of the experiment about 400 Individuals of F.candida were given in the phytocosms. THis number accords to Collemboln densities from Tischler (19XX) for agricultural fields. After the expereimten Collembolans were extracted by dynamic heat extraction afer MacFadyen. Ther had been Invasion Events in Phytocosms with originally Collembolan free treatments, e.g. Single Species L. terrestris and Control. In these Phytocosms Individuals of F. candida were found in the samples after Extraction. Another Kind of Invasion took place irrespective of the Treatments. here other Collembolan Species or arthropods invaded in the phytocosms. Alien Collembolan Species were almost eclusively Sminthurinus aureus and sometimes I. minuta. Alien arthropods were mainly flies, e.g. Trauermücken. But these Invasions took place with too less Individuals, so that they're not regarded as disturbance of the experiment and effects were analysed with no regard to these Invasion events.

The data set:
The data set consists mainly of absolute numbers of Collembolans in the extraction samples. Sometimes Valentina Sandor counted 10% of the samples and extrapolated the numbers. Here I was not sure, when which method was perforemd and disregarded this. Nevertheless the numbers should be calculated to Individuals/cm^2 or Individuals/Phytocosms.

Soil cores for extraction (n=4): diameter=2cm, height=10cm
Phytocosms: diameter= Xcm, height=Xcm
Phytocosm topsoil= diameter= ; height= 10cm

For the present I used the absolute Numbers from extraction samples in analyses

```{r F. candida population}
col.pop <- cbind(index,col=col.pop[,6])

# Boxplot for Collembolan population
ggplot(col.pop, aes(x= interaction(Fc,Lt), y=col),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("Individual/Extraction"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("F. candida"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme
```

### Analysis
```{r Analysis 1}
str(col.pop)
col.pop=col.pop[-c(41,82),]

col.pop2 <- col.pop[!(with(col.pop, treat=="Lt" | treat=="Control")),]
col.pop2 <- droplevels(col.pop2)


# Multimodel Averaging
x <- c("Lt", "plant", "soil")
col.lm0 <- lm(col~Lt*plant*soil, col.pop2)
t(combn(x, 2))
col.lm1 <- lm(col~Lt*plant, col.pop2)
col.lm2 <- lm(col~Lt*soil, col.pop2)
col.lm3 <- lm(col~plant*soil, col.pop2)
t(combn(x, 1))
col.lm4 <- lm(col~Lt, col.pop2)
col.lm5 <- lm(col~plant, col.pop2)
col.lm6 <- lm(col~soil, col.pop2)

col.lm7 <- lm(col~1, col.pop2)


AICctab(col.lm1,col.lm2,col.lm3,col.lm4,col.lm5,col.lm6,col.lm7)

#factor(paste("col.lm",0:15,",", sep=""))
#factor(paste("col.lm",0:15,"summary(col.lm", sep=""))

# Model validation
par(mfrow=c(2,2))
par(mar=c(3,3,3,3))
plot(col.lm1)
par(mfrow=c(1,1))
#boxcox(col.best, lambda=seq(-0.2, 0.8, 0.01))
#locator(1)
col.lm1 <- update(col.lm1,sqrt(col)~.) #Square root transformation, because of Model Validation

# Best Model
col.best <- col.lm1;summary.aov(col.best)
col.best2 <- update(col.lm1, .~Lt+plant);anova(col.best, col.best2); AICctab(col.best, col.best2)
summary.aov(col.best2)

fligner.test(col~interaction(Lt,plant), data=col.pop2)

par(mfrow=c(1,1))
with(col.pop2, plot.design(col~Lt+plant))

# Boxplots
ggplot(col.pop, aes(x= interaction(Fc,Lt), y=col),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("Individual/Extraction"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("F. candida"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme

# Means and Standard Errors
with(col.pop2, list(tapply(col,Lt,mean),tapply(col,Lt,se)))
with(col.pop2, list(tapply(col,plant,mean),tapply(col,plant,se)))
with(col.pop, list(tapply(col,list(plant,soil,treat==c("Lt", "Control")),mean)))
with(col.pop, list(tapply(col,list(plant,soil,treat==c("Lt", "Control")),se)))
```

### Reporting Results
### Collembolan "absolute Individuals Numbers per extraction" have been square root transformed prior to analysis. There were two significant main effects one of plant species (ANOVA; F(1,37)=20.7;p<0.001) and another of presence of L. terrestris (ANOVA; F(1,37)=5.1;p=0.03). In Phytocosms with S. perfoliatum Collembolan "numbers" were with 218 +/- 32 higher thatn in Z. mays with 77 +/- 19 Individuals. Presence of L. terrestris decreased collembolan population from 195 +/- 37 to 100 +/- 18 Individuals. Soil texture had no significant Influence, but it was observed, that  invasion of F. candida in other Phytocosms only occured successfully in sandy soil Phytocosms with S. perfoliatum with in average 82.6 +/- 21 Individuals.

# C/N Measurements

#### Data Exploration
I do Boxplots for the differences between measurements from after and before the experiment. The values for the "before" data are all the same. From these values we get to know some kind of baseline for the bulk soil used in all of the Phytocosms.By comparisons to this baseline, we can estimate if there had been high or low alteration of these qualities. But the variation of the data is exclusively prone from the "after"" measurements and will be retained in the plots for differences, because we subtract the same value from all of the "after" measures.


```{r C/N}
CN$plant <- revalue(CN$plant, c(Sp ="italic(S.~perfoliatum)",Zm="italic(Z.~mays)"))

# Boxplot for CN-ratio
ggplot(CN, aes(x= interaction(Fc,Lt), y=CN.after-CN.before),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("Soil CN-ratio"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("CN-Ratio - change during the experiment experiment"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme

# Boxplot for Nitrogen
ggplot(CN, aes(x= interaction(Fc,Lt), y=N.after-N.before),labeller=label_parsed) + 
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("Soil Nitrogen [%]"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("Nitrogen change durig the experiment"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme

# Boxplot for Carbon
ggplot(CN, aes(x= interaction(Fc,Lt), y=C.after-C.before),labeller=label_parsed) + 
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("Soil Carbon [%]"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("Carbon change during the experiment"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme

with(CN, tapply(N.after-N.before, soil, mean))
with(CN, tapply(N.after-N.before, soil, se))
with(CN, tapply(CN.after-CN.before, soil, min))
with(CN, tapply(CN.after-CN.before, soil, max))

```

Variation in c and N was higher in Sand. I'd say sand is the more variable soil with regard to  potential nutrient content. But were do we find this variability? All the sandy soil came from one bulk sample/storage, can we find variability here?. We took soil from the big pool and distributed it to the phytocosms and then took a small sample from each of the phytocosms after the experiment and saw that these small phytocosm samples vary from vessel to vessel. Why should there not been variation within one phytocosm?. I, think we could have get a different pattern of variation, if we'd taken the samples from another place within the phytocosm. Or is this variability even affected by our treatments? Even if it was, the variabilit in sand is less than in loam.
Interstingly we have the highest variability in single species treatments with F. candida. And the only distinct increase was observed in sandy soil texture with S. perfoliatum. 

But: Overall Changes between before and after are unexpectedly low, only between 0.1 and 0.7 % for Carbon and between -0.02 and 0.03 % for Nitrogen. Nevertheless the only treatment, suggesting an increase in nitrogen content was sandy S. perfoliatum treatment, which was the treatment with the most pronounced increase in L. terrestris biomass. The CN ratio changes for -0.3 to 4 units. This seems to be possibly meaningful


## Analysis

```{r Analysis 2}
#Are there significant changed from before to after?
with(CN, t.test(CN.after, CN.before, paired=T, alternative="greater")) 
with(CN, t.test(N.after, N.before, paired=T, alternative="greater")) 
with(CN, t.test(C.after, C.before, paired=T, alternative="greater")) 

# Yes all Parameters increased significantly! 
# But here the test is probably invalid due to the lack of variation in the "before" data ??

# are the differences between before and after affected by any the treatments?
CN.aov1 <- aov(CN.after -CN.before ~ Fc*Lt*plant*soil, CN); summary(CN.aov1)
CN.aov1 <- aov(CN.after -CN.before ~ Fc*plant*soil, CN); summary(CN.aov1)
CN.aov1 <- aov(CN.after -CN.before ~ plant*soil, CN); summary(CN.aov1)
CN.aov1 <- aov(CN.after ~ plant*soil, CN); summary(CN.aov1)
summary.lm(CN.aov1)

TukeyHSD(CN.aov1)

# the only significant influence is the soil texture dependent on plant species, from post hoc Tukey HSD we find, that sandy soil in combination with S. perfoliatum has significantly increased CN ratio after the end of the experiment (TukeyHSD; p<0.001).

with(CN, tapply(CN.after, list(soil,plant),mean))
with(CN, tapply(CN.after, list(soil,plant),se))
```

From Analysis of CN ratio we have to admit, that soil fauna was not influential. But S. perfoliatum seems to have the ability to increase the CN ratio in sandy soil texture. But how is this increase fullfilled? increase in both, but stronger increase in C.

# pH
```{r pH}
pH$pH.change  <- with(pH, pH5-pH1)

# Boxplot for root Biomass change
ggplot(pH, aes(x= interaction(Fc,Lt), y=pH.change),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("pH"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("pH change"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme
```

There was a stronger change in pH for S. perfoliatum and additionally a stronger change in sandy soil. The latter was also obvious in the Wp treatments. 
What are the underlying mechanisms?

### Analysis
```{r Analysis 3}
str(pH)
pH <-pH[-c(41,82),]
pH <- droplevels(pH)


# Multimodel Averaging
x <- c("Lt", "Fc", "plant", "soil")
pH5.lm0 <- lm(pH5~Lt*Fc*plant*soil, pH)
t(combn(x, 3))
pH5.lm1 <- lm(pH5~Lt*Fc*plant, pH)
pH5.lm2 <- lm(pH5~Lt*Fc*soil, pH)
pH5.lm3 <- lm(pH5~Lt*plant*soil, pH)
pH5.lm4 <- lm(pH5~Fc*plant*soil, pH)
t(combn(x, 3))
pH5.lm5 <- lm(pH5~Lt*Fc, pH)
pH5.lm6 <- lm(pH5~Lt*plant, pH)
pH5.lm7 <- lm(pH5~Lt*soil, pH)
pH5.lm8 <- lm(pH5~Fc*plant, pH)
pH5.lm9 <- lm(pH5~Fc*soil, pH)
pH5.lm10 <- lm(pH5~plant*soil, pH)
t(combn(x, 1))
pH5.lm11 <- lm(pH5~Lt, pH)
pH5.lm12 <- lm(pH5~Fc, pH)
pH5.lm13 <- lm(pH5~plant, pH)
pH5.lm14 <- lm(pH5~soil, pH)

pH5.lm15 <- lm(pH5~1, pH)


#factor(paste("pH5.lm",0:15,",", sep=""))
#factor(paste("pH5.lm",0:15,"summary(pH5.lm", sep=""))

AICctab(pH5.lm1,pH5.lm2,pH5.lm3,pH5.lm4,pH5.lm5,pH5.lm6,pH5.lm7,pH5.lm8,pH5.lm9,pH5.lm10,pH5.lm11,pH5.lm12,pH5.lm13,pH5.lm14,pH5.lm15)

# Model validation
par(mfrow=c(2,2))
par(mar=c(3,3,3,3))
plot(pH5.lm10)
par(mfrow=c(1,1))

fligner.test(pH5~interaction(plant,soil), data=pH) 
# There is no violation of Homoscedasticity

# Best Model
pH5.best <- pH5.lm10;summary.aov(pH5.best)
pH5.best2 <- update(pH5.lm10, .~.-plant:soil);anova(pH5.best, pH5.best2); AICctab(pH5.best, pH5.best2)

pH5.best <- pH5.best2
summary.aov(pH5.best)

par(mfrow=c(1,1))
with(pH, plot.design(pH5~plant+soil))

# Boxplot for root Biomass change
ggplot(pH, aes(x=1, y=pH5),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("pH"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("pH"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  #scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme

with(pH, list(tapply(pH5,plant,mean),
              tapply(pH5, plant, se)))

with(pH, list(tapply(pH5,soil,mean),
              tapply(pH5, soil, se)))
```

### Reporting results:
### ANOVA revealed two main effects for pH5: Soil texture (ANOVA; F(1,77)=108;p<0.001) and plant species(ANOVA;F(1,77)=169;p<0.001). Loamy soil had significantly more basic pH with 6.7 +/- 0.0 compared to 6.5 +/- 0.0 in sandy soil. More basic pH was also found in S. perfoliatum with with 6.7 +/- 0.0 compared to 6.5 +/- 0.0 in Z. mays. But although those difference are significant, they are meaningless. A difference of 0.2 pH is not likely to cause any effects.

# pH change
```{r pH Change}

# Multimodel Averaging
x <- c("Lt", "Fc", "plant", "soil")
pH.change.lm0 <- lm(pH.change~Lt*Fc*plant*soil, pH)
t(combn(x, 3))
pH.change.lm1 <- lm(pH.change~Lt*Fc*plant, pH)
pH.change.lm2 <- lm(pH.change~Lt*Fc*soil, pH)
pH.change.lm3 <- lm(pH.change~Lt*plant*soil, pH)
pH.change.lm4 <- lm(pH.change~Fc*plant*soil, pH)
t(combn(x, 3))
pH.change.lm5 <- lm(pH.change~Lt*Fc, pH)
pH.change.lm6 <- lm(pH.change~Lt*plant, pH)
pH.change.lm7 <- lm(pH.change~Lt*soil, pH)
pH.change.lm8 <- lm(pH.change~Fc*plant, pH)
pH.change.lm9 <- lm(pH.change~Fc*soil, pH)
pH.change.lm10 <- lm(pH.change~plant*soil, pH)
t(combn(x, 1))
pH.change.lm11 <- lm(pH.change~Lt, pH)
pH.change.lm12 <- lm(pH.change~Fc, pH)
pH.change.lm13 <- lm(pH.change~plant, pH)
pH.change.lm14 <- lm(pH.change~soil, pH)

pH.change.lm15 <- lm(pH.change~1, pH)


#factor(paste("pH.change.lm",0:15,",", sep=""))
#factor(paste("pH.change.lm",0:15,"summary(pH.change.lm", sep=""))

AICctab(pH.change.lm1,pH.change.lm2,pH.change.lm3,pH.change.lm4,pH.change.lm5,pH.change.lm6,pH.change.lm7,pH.change.lm8,pH.change.lm9,pH.change.lm10,pH.change.lm11,pH.change.lm12,pH.change.lm13,pH.change.lm14,pH.change.lm15)

# Model validation
par(mfrow=c(2,2))
par(mar=c(3,3,3,3))
plot(pH.change.lm10)

fligner.test(pH.change~interaction(plant,soil), data=pH) 
# There is no violation of Homoscedasticity

# Best Model
pH.change.best <- pH.change.lm10;summary.aov(pH.change.best)
pH.change.best2 <- update(pH.change.lm10, .~.-plant:soil);anova(pH.change.best, pH.change.best2); AICctab(pH.change.best, pH.change.best2)

pH.change.best <- pH.change.best2
summary.aov(pH.change.best)

par(mfrow=c(1,1))
with(pH, plot.design(pH.change~plant+soil))

# Boxplot for root Biomass change
ggplot(pH, aes(x=1, y=pH.change),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("pH"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("pH change"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  #scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme

with(pH, list(tapply(pH.change,plant,mean),
              tapply(pH.change, plant, se)))

with(pH, list(tapply(pH.change,soil,mean),
              tapply(pH.change, soil, se)))
```
### Reporting results
### With regard to pH change the effect for soil texture reversed. Here we observe a stronger trend towards basic pH in sandy soil. The effect for S. perfoliatum stays the same, it is more basic compared to Maize. nevertheless these changes are in a very small range. Again it's questionable if they're meaningful. Perhaps you could argue, that maize rather tends to cause no changes and any increase is rather caused from soil texture, wherea in Phytocosms with S. perfoliatum we'd observe combining effects of soil texture and plant. 
  
* How would S.perfoliatum increase the pH?
* How would Sany soil increase the pH?


# Root biomass

```{r Roots Biomass}
roots <- cbind(index, roots[,c(6,7)])
roots <-roots[-c(41,82),]
roots <- droplevels(roots)
roots$roic <- roots$root.after - roots$root.before

# Boxplot for root Biomass change
ggplot(roots, aes(x= interaction(Fc,Lt), y=root.after-root.before),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("biomass [g]"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("Root biomass change"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme

```


# Analysis
```{r Analysis}
str(roots)
with(roots, which(roic<=0))
roots$roic[c(48,78,80)] = 0 # There can't be negative root growth


# Multimodel Averaging
x <- c("Lt", "Fc", "plant", "soil")
roic.lm0 <- lm(roic~Lt*Fc*plant*soil, roots)
t(combn(x, 3))
roic.lm1 <- lm(roic~Lt*Fc*plant, roots)
roic.lm2 <- lm(roic~Lt*Fc*soil, roots)
roic.lm3 <- lm(roic~Lt*plant*soil, roots)
roic.lm4 <- lm(roic~Fc*plant*soil, roots)
t(combn(x, 3))
roic.lm5 <- lm(roic~Lt*Fc, roots)
roic.lm6 <- lm(roic~Lt*plant, roots)
roic.lm7 <- lm(roic~Lt*soil, roots)
roic.lm8 <- lm(roic~Fc*plant, roots)
roic.lm9 <- lm(roic~Fc*soil, roots)
roic.lm10 <- lm(roic~plant*soil, roots)
t(combn(x, 1))
roic.lm11 <- lm(roic~Lt, roots)
roic.lm12 <- lm(roic~Fc, roots)
roic.lm13 <- lm(roic~plant, roots)
roic.lm14 <- lm(roic~soil, roots)

roic.lm15 <- lm(roic~1, roots)


#factor(paste("roic.lm",0:15,",", sep=""))
#factor(paste("roic.lm",0:15,"summary(roic.lm", sep=""))

AICctab(roic.lm1,roic.lm2,roic.lm3,roic.lm4,roic.lm5,roic.lm6,roic.lm7,roic.lm8,roic.lm9,roic.lm10,roic.lm11,roic.lm12,roic.lm13,roic.lm14,roic.lm15)

# Model validation
par(mfrow=c(2,2))
par(mar=c(3,3,3,3))
plot(roic.lm3)
par(mfrow=c(1,1))
#boxcox(roic.lm3, lambda=seq(-0.2, 0.8, 0.01))
#locator(1)

fligner.test(roic~interaction(Lt,plant,soil), data=roots) 
# There is severe violation of Homoscedasticity
# But validation plots don't look too bad
# And tying transformations (sqrt, log1p, sqrt(x+1)), didn't show an effect
# Therefore I go on with the regular model

# Best Model
roic.best <- roic.lm3;summary.aov(roic.best)
roic.best2 <- update(roic.lm3, .~.-Lt:plant);anova(roic.best, roic.best2); AICctab(roic.best, roic.best2)


par(mfrow=c(1,1))
with(roots, plot.design(roic~Lt+plant+soil))

# Post Hoc Tukey test


# Boxplots
ggplot(roots, aes(x= interaction(Fc,Lt), y=roic),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("Biomass change [g]"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("Root growth"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme

# Post Hoc Tukey Test
roic.best.aov <- aov(roic~ Lt*plant*soil, roots)
TukeyHSD(roic.best.aov)

# Post Hoc Tukey Test
                roic.int <- with(roots, interaction(Lt,soil,plant)) # triple Interactio Factor
                roic.best.aov2 <- update(roic.best.aov, .~ roic.int)
                HSD.test(roic.best.aov2, "roic.int", group=TRUE, console=TRUE) 
                roic.tuk1 <- glht(roic.best.aov2, linfct = mcp(roic.int = "Tukey"))
                summary(roic.tuk1)          # standard display
                roic.tuk.cld <- cld(roic.tuk1)   # letter-based display
                par(mai=c(1,1,1.1,0.2),  # mai specifies margin size in inches
                    mfrow=c(1,1),
                    mgp=c(2,1,0),
                    cex=0.8) 
                plot(roic.tuk.cld, cex=0.5, las=2, col="grey", xaxt="n")
                axis(1, at=roic.int,labels=FALSE)
                text(roic.int, labels=roic.int, par("usr")[3], adj=c(1.2,1.2), xpd=TRUE, srt=45, cex=0.8)

# Means and Standard Errors
with(roots, list(tapply(roic,Lt,mean),tapply(roic,Lt,se)))
with(roots, list(tapply(roic,plant,mean),tapply(roic,plant,se)))
with(roots, list(tapply(roic,list(plant,soil,treat==c("Lt", "Control")),mean)))
with(roots, list(tapply(roic,list(plant,soil,treat==c("Lt", "Control")),se)))

```

# Shoot Biomass
```{r Shoot biomass}
shoots <- cbind(index, shoots[,c(6,7)])
shoots <-shoots[-c(41,82),]
shoots <- droplevels(shoots)
shoots$shoic <- shoots$shoot.after - shoots$shoot.before

# Boxplot for root Biomass change
ggplot(shoots, aes(x= interaction(Fc,Lt), y=shoot.after-shoot.before),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("biomass [g]"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("Shoot biomass change"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme

```

# Analysis
```{r}
str(shoots)
with(shoots, which(shoic<=0))



# Multimodel Averaging
x <- c("Lt", "Fc", "plant", "soil")
shoic.lm0 <- lm(shoic~Lt*Fc*plant*soil, shoots)
t(combn(x, 3))
shoic.lm1 <- lm(shoic~Lt*Fc*plant, shoots)
shoic.lm2 <- lm(shoic~Lt*Fc*soil, shoots)
shoic.lm3 <- lm(shoic~Lt*plant*soil, shoots)
shoic.lm4 <- lm(shoic~Fc*plant*soil, shoots)
t(combn(x, 3))
shoic.lm5 <- lm(shoic~Lt*Fc, shoots)
shoic.lm6 <- lm(shoic~Lt*plant, shoots)
shoic.lm7 <- lm(shoic~Lt*soil, shoots)
shoic.lm8 <- lm(shoic~Fc*plant, shoots)
shoic.lm9 <- lm(shoic~Fc*soil, shoots)
shoic.lm10 <- lm(shoic~plant*soil, shoots)
t(combn(x, 1))
shoic.lm11 <- lm(shoic~Lt, shoots)
shoic.lm12 <- lm(shoic~Fc, shoots)
shoic.lm13 <- lm(shoic~plant, shoots)
shoic.lm14 <- lm(shoic~soil, shoots)

shoic.lm15 <- lm(shoic~1, shoots)


#factor(paste("shoic.lm",0:15,",", sep=""))
#factor(paste("shoic.lm",0:15,"summary(shoic.lm", sep=""))

AICctab(shoic.lm1,shoic.lm2,shoic.lm3,shoic.lm4,shoic.lm5,shoic.lm6,shoic.lm7,shoic.lm8,shoic.lm9,shoic.lm10,shoic.lm11,shoic.lm12,shoic.lm13,shoic.lm14,shoic.lm15)

# Model validation
par(mfrow=c(2,2))
par(mar=c(3,3,3,3))
plot(shoic.lm3)
par(mfrow=c(1,1))
boxcox(shoic.lm3, lambda=seq(-0.2, 0.8, 0.01))
# locator(1)
#--> Square root transformation

shoic.lm3 <- update(shoic.lm3, sqrt(shoic)~.)

fligner.test(shoic~interaction(Lt,plant,soil), data=shoots) 
# There is no violation of Homoscedasticity

# Best Model
shoic.best <- shoic.lm3;summary.aov(shoic.best)
shoic.best2 <- update(shoic.lm3, .~.-Lt:plant-Lt:soil-Lt:plant:soil);anova(shoic.best, shoic.best2); AICctab(shoic.best, shoic.best2)

shoic.best <- shoic.best2

par(mfrow=c(1,1))
with(shoots, plot.design(shoic~Lt+plant+soil))

# Boxplots
ggplot(shoots, aes(x= soil, y=shoic),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("Biomass change [g]"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("Shoot growth"))) +
  facet_grid(plant~Lt, labeller=label_parsed) + 
  mytheme

# Means and Standard Errors
with(shoots, list(tapply(shoic,Lt,mean),tapply(shoic,Lt,se)))
with(shoots, list(tapply(shoic,plant,mean),tapply(shoic,plant,se)))
with(shoots, list(tapply(shoic,list(plant,soil),mean)))
with(shoots, list(tapply(shoic,list(plant,soil),se)))
```


# Root:Shoot ratio
```{r}
rsr <- roots$root.after/shoots$shoot.after
rsr <- cbind(index[-c(41,82),], rsr=rsr)
rsr <- droplevels(rsr)
str(rsr)

# Boxplot for root Biomass change
ggplot(rsr, aes(x= interaction(Fc,Lt), y=rsr),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("biomass [g]"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("Root:Shoot Ratio"))) +
  facet_grid(plant~soil, labeller=label_parsed) + 
  scale_x_discrete("Treatment", labels=expression(Control,italic(F.~candida), italic(L.~terrestris), Interaction)) +
  mytheme

```
#Analysis
```{r}
str(rsr)

# Multimodel Averaging
x <- c("Lt", "Fc", "plant", "soil")
rsr.lm0 <- lm(rsr~Lt*Fc*plant*soil, rsr)
t(combn(x, 3))
rsr.lm1 <- lm(rsr~Lt*Fc*plant, rsr)
rsr.lm2 <- lm(rsr~Lt*Fc*soil, rsr)
rsr.lm3 <- lm(rsr~Lt*plant*soil, rsr)
rsr.lm4 <- lm(rsr~Fc*plant*soil, rsr)
t(combn(x, 3))
rsr.lm5 <- lm(rsr~Lt*Fc, rsr)
rsr.lm6 <- lm(rsr~Lt*plant, rsr)
rsr.lm7 <- lm(rsr~Lt*soil, rsr)
rsr.lm8 <- lm(rsr~Fc*plant, rsr)
rsr.lm9 <- lm(rsr~Fc*soil, rsr)
rsr.lm10 <- lm(rsr~plant*soil, rsr)
t(combn(x, 1))
rsr.lm11 <- lm(rsr~Lt, rsr)
rsr.lm12 <- lm(rsr~Fc, rsr)
rsr.lm13 <- lm(rsr~plant, rsr)
rsr.lm14 <- lm(rsr~soil, rsr)

rsr.lm15 <- lm(rsr~1, rsr)


#factor(paste("rsr.lm",0:15,",", sep=""))
#factor(paste("rsr.lm",0:15,"summary(rsr.lm", sep=""))

AICctab(rsr.lm1,rsr.lm2,rsr.lm3,rsr.lm4,rsr.lm5,rsr.lm6,rsr.lm7,rsr.lm8,rsr.lm9,rsr.lm10,rsr.lm11,rsr.lm12,rsr.lm13,rsr.lm14,rsr.lm15)

# Model validation
par(mfrow=c(2,2))
par(mar=c(3,3,3,3))
plot(rsr.lm10)
par(mfrow=c(1,1))
boxcox(rsr.lm10, lambda=seq(-1, 0.2, 0.01))
# locator(1)
# negative square root????? or what??

fligner.test(rsr~interaction(plant,soil), data=rsr) 
# There is severe violation of Homoscedasticity
# But i don't know how to transform the data according to boxcox
# Transformation for percentage data would be arcsine

# Best Model
rsr.best <- rsr.lm10;summary.aov(rsr.best)

par(mfrow=c(1,1))
with(rsr, plot.design(rsr~plant+soil))

# Boxplots
ggplot(rsr, aes(x= soil, y=rsr),labeller=label_parsed) +
  stat_boxplot(geom="errorbar", coef=1.5, lwd=0.2) + 
  geom_boxplot(fill="light blue", lwd=0.2, outlier.size=0.4, outlier.shape=21) +
  ylab(expression(paste("ratio"))) +
  xlab("Treatment") +
  ggtitle(expression(paste("Root:Shoot ratio"))) +
  facet_grid(~plant, labeller=label_parsed) + 
  mytheme

# Post Hoc tests

# Means and Standard Errors
with(rsr, list(tapply(rsr,Lt,mean),tapply(rsr,Lt,se)))
with(rsr, list(tapply(rsr,plant,mean),tapply(rsr,plant,se)))
with(rsr, list(tapply(rsr,list(plant,soil),mean)))
with(rsr, list(tapply(rsr,list(plant,soil),se)))
```


# Microbial Biomass
```{r Microbial Biomass}
cmic2 <- cmic[!(cmic$plant=="Wp"),]
cmic2$ID1  <- as.factor(rep(c(1:15),16))
cmic2$treat <- factor(cmic2$treat, levels=c("Lt","Fc","Mix","Control"))
# Boxplot for Cmic
ggplot(cmic2, aes(x= ID1, y=Cmic),group=cosm, labeller=label_parsed) +
  geom_bar(fill="light blue", col="black", lwd=0.2, stat="identity") +
  ylab(expression(paste("µ-C /g soil"))) +
  xlab("Pseudo-Replicates") +
  ggtitle(expression(paste("Microbial Biomass - Outlier search"))) +
  facet_grid(soil~plant+treat, labeller=label_parsed) + 
  mytheme

which(cmic2$Cmic<200)
with(cmic2[(cmic2$treat=="Lt" & cmic2$plant=="Zm" & cmic2$soil=="Loam"),], which(cmic2$Cmic==min(Cmic)))
 cmic2 <- cmic2[-c(53,  83,  89, 128, 145,95),]
```

### Analysis
```{r}
# A model with Error Structure; Nested design
cmic.aov1 <- aov(Cmic~treat*plant*soil + Error(interaction(cosm,soil)), cmic2); summary(cmic.aov1)

# unfortunately i don't know how to do model simplification with this

cmic.means <- data.frame(cbind(index[with(index, order(soil,cosm)),][-c(41,82),],
                               Cmic.means=as.numeric(with(cmic2, tapply(Cmic, interaction(cosm,soil),mean)))))

str(cmic.means)
cmic.means <- droplevels(cmic.means)

ggplot(cmic.means, aes(x=Cmic.means),group=cosm, labeller=label_parsed) +
  geom_bar(fill="light blue", col="black", lwd=0.2, stat="bin") +
  ylab(expression(paste("µ-C /g soil"))) +
  xlab("Pseudo-Replicates") +
  ggtitle(expression(paste("Microbial Biomass - Outlier search"))) +
  #facet_grid(soil~plant+treat, labeller=label_parsed) + 
  mytheme

# multi model averaging

cmic.means <- cmic.means[-c(10,11),]

# Multimodel Averaging
x <- c("Lt", "Fc", "plant", "soil")
cmic.lm0 <- lm(Cmic.means~Lt*Fc*plant*soil, cmic.means)
t(combn(x, 3))
cmic.lm1 <- lm(Cmic.means~Lt*Fc*plant, cmic.means)
cmic.lm2 <- lm(Cmic.means~Lt*Fc*soil, cmic.means)
cmic.lm3 <- lm(Cmic.means~Lt*plant*soil, cmic.means)
cmic.lm4 <- lm(Cmic.means~Fc*plant*soil, cmic.means)
t(combn(x, 3))
cmic.lm5 <- lm(Cmic.means~Lt*Fc, cmic.means)
cmic.lm6 <- lm(Cmic.means~Lt*plant, cmic.means)
cmic.lm7 <- lm(Cmic.means~Lt*soil, cmic.means)
cmic.lm8 <- lm(Cmic.means~Fc*plant, cmic.means)
cmic.lm9 <- lm(Cmic.means~Fc*soil, cmic.means)
cmic.lm10 <- lm(Cmic.means~plant*soil, cmic.means)
t(combn(x, 1))
cmic.lm11 <- lm(Cmic.means~Lt, cmic.means)
cmic.lm12 <- lm(Cmic.means~Fc, cmic.means)
cmic.lm13 <- lm(Cmic.means~plant, cmic.means)
cmic.lm14 <- lm(Cmic.means~soil, cmic.means)

cmic.lm15 <- lm(Cmic.means~1, cmic.means)


#factor(paste("cmic.lm",0:15,",", sep=""))
#factor(paste("cmic.lm",0:15,"summary(cmic.lm", sep=""))

AICctab(cmic.lm1,cmic.lm2,cmic.lm3,cmic.lm4,cmic.lm5,cmic.lm6,cmic.lm7,cmic.lm8,cmic.lm9,cmic.lm10,cmic.lm11,cmic.lm12,cmic.lm13,cmic.lm14,cmic.lm15)

# Model validation
par(mfrow=c(2,2))
par(mar=c(3,3,3,3))
plot(cmic.lm3)
par(mfrow=c(1,1))
# very nice model!

fligner.test(Cmic.means~interaction(Lt,plant,soil), data=cmic.means) 
# There is no violation of Homoscedasticity

# Best Model
cmic.best <- cmic.lm3;summary.aov(cmic.best)
cmic.best2 <- update(cmic.lm3, .~.-Lt:plant-Lt:soil-Lt:plant:soil);anova(cmic.best, cmic.best2); AICctab(cmic.best, cmic.best2)
summary.aov(cmic.best2)
cmic.best <- cmic.best2

# Model validation
par(mfrow=c(2,2))
par(mar=c(3,3,3,3))
plot(cmic.best)


par(mfrow=c(1,1))
with(cmic.means, plot.design(Cmic.means~Lt+plant+soil))

# Post Hoc Tukey Test
cmic.best.aov <- aov(Cmic.means~ Lt*plant*soil-Lt:plant-Lt:soil-Lt:plant:soil, cmic.means)
TukeyHSD(cmic.best.aov)

# Post Hoc Tukey Test
                cmic.int <- with(cmic.means, interaction(soil,plant)) # Double Interactio Factor
                cmic.best.aov2 <- update(cmic.best.aov, .~ cmic.int)
                HSD.test(cmic.best.aov2, "cmic.int", group=TRUE, console=TRUE) 
                cmic.tuk1 <- glht(cmic.best.aov2, linfct = mcp(cmic.int = "Tukey"))
                summary(cmic.tuk1)          # standard display
                cmic.tuk.cld <- cld(cmic.tuk1)   # letter-based display
                par(mai=c(1,1,1.1,0.2),  # mai specifies margin size in inches
                    mfrow=c(1,1),
                    mgp=c(2,1,0),
                    cex=0.8) 
                plot(cmic.tuk.cld, cex=0.5, las=2, col="grey", xaxt="n")
                axis(1, at=cmic.int,labels=FALSE)
                text(cmic.int, labels=c("Loam X Sp","Sand X Sp", "Loam X Zm", "Sand X Sp"), par("usr")[3], adj=c(1.2,1.2), xpd=TRUE, srt=45, cex=0.8)

with(cmic.means, list(tapply(Cmic.means, Lt, mean),
                      tapply(Cmic.means, Lt, se)))
with(cmic.means, list(tapply(Cmic.means, interaction(plant,soil), mean),
                      tapply(Cmic.means, interaction(plant,soil), se)))

```

# Plant nutrients
During the course of the experiment samples for percolation water, were taken five times in intervals of XX days. The first time was before the introduction of soil fauna. I guess with this sampling most of the plant nutrients were wshed out, Therfore i'll regard these values as kind of initial differences and will exclude them from analysis.

### the data set:
The data set lacked values for the "without plant" treatments. The data set consists of repeated mesurements from the same Phytocosms. This kind of pseudoreplication must be taken into account. I'm not sure if the data from RESULTS was NO3-N or not. Therfore I'm not sure of the units of measurement.

```{r Leaching}

str(leaching)

leaching.melt <- melt(leaching, id.vars=c(1:7))
leaching.melt <-concat.split.multiple(leaching.melt, "variable", ".")

leaching2 <- leaching.melt[!(leaching.melt$variable_2==1),]

ggplot(leaching2, aes(x=variable_2, y=value, col=treat), labeller=label_parsed) +
  geom_point(lwd=2) +
  ylab(expression(paste("?????"))) +
  xlab("sampling dates") +
  ggtitle(expression(paste("Percolation Water"))) +
  facet_grid(variable_1+plant~soil, labeller=label_parsed) + 
  mytheme + theme(legend.position="bottom")
````
There is a very high variation in the range of plant nutrients for the interaction between soil and plant species.

# Ammonia

```{r}

ggplot(leaching2[(leaching2$variable_1=="NH4"),], aes(x=variable_2, y=value, col=treat), labeller=label_parsed) +
  geom_point(lwd=2) +
  ylab(expression(paste("?????"))) +
  xlab("sampling dates") +
  ggtitle(expression(paste("Percolation Water"))) +
  facet_grid(variable_1+plant~soil, labeller=label_parsed) + 
  mytheme + theme(legend.position="bottom")

# Multimodel Averaging
x <- c("Lt", "Fc", "plant", "soil")
leach.lm0 <- lmer(value~Lt*Fc*plant*soil+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
t(combn(x, 3))
leach.lm1 <- lmer(value~Lt*Fc*plant+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm2 <- lmer(value~Lt*Fc*soil+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm3 <- lmer(value~Lt*plant*soil+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm4 <- lmer(value~Fc*plant*soil+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
t(combn(x, 3))
leach.lm5 <- lmer(value~Lt*Fc+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm6 <- lmer(value~Lt*plant+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm7 <- lmer(value~Lt*soil+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm8 <- lmer(value~Fc*plant+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm9 <- lmer(value~Fc*soil+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm10 <- lmer(value~plant*soil+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
t(combn(x, 1))
leach.lm11 <- lmer(value~Lt+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm12 <- lmer(value~Fc+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm13 <- lmer(value~plant+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])
leach.lm14 <- lmer(value~soil+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])

leach.lm15 <- lmer(value~1+(1|ID), leaching2[(leaching2$variable_1=="NH4"),])


#factor(paste("leach.lm",0:15,",", sep=""))
#factor(paste("leach.lm",0:15,"summary(leach.lm", sep=""))

AICctab(leach.lm1,leach.lm2,leach.lm3,leach.lm4,leach.lm5,leach.lm6,leach.lm7,leach.lm8,leach.lm9,leach.lm10,leach.lm11,leach.lm12,leach.lm13,leach.lm14,leach.lm15)


```



### Pseudoreplication averaged away
```{r}
leaching.means <- data.frame(cbind(leaching[,c(1:6)],
                               NH4=as.numeric(with(leaching2[(leaching2$variable_1=="NH4"),], tapply(value, interaction(cosm,soil),mean)))),
                               NO3=as.numeric(with(leaching2[(leaching2$variable_1=="NO3"),], tapply(value, interaction(cosm,soil),mean))))

# Multimodel Averaging
x <- c("Lt", "Fc", "plant", "soil")
NH4.lm0 <- lm(NH4~Lt*Fc*plant*soil, leaching.means)
t(combn(x, 3))
NH4.lm1 <- lm(NH4~Lt*Fc*plant, leaching.means)
NH4.lm2 <- lm(NH4~Lt*Fc*soil, leaching.means)
NH4.lm3 <- lm(NH4~Lt*plant*soil, leaching.means)
NH4.lm4 <- lm(NH4~Fc*plant*soil, leaching.means)
t(combn(x, 3))
NH4.lm5 <- lm(NH4~Lt*Fc, leaching.means)
NH4.lm6 <- lm(NH4~Lt*plant, leaching.means)
NH4.lm7 <- lm(NH4~Lt*soil, leaching.means)
NH4.lm8 <- lm(NH4~Fc*plant, leaching.means)
NH4.lm9 <- lm(NH4~Fc*soil, leaching.means)
NH4.lm10 <- lm(NH4~plant*soil, leaching.means)
t(combn(x, 1))
NH4.lm11 <- lm(NH4~Lt, leaching.means)
NH4.lm12 <- lm(NH4~Fc, leaching.means)
NH4.lm13 <- lm(NH4~plant, leaching.means)
NH4.lm14 <- lm(NH4~soil, leaching.means)

NH4.lm15 <- lm(NH4~1, leaching.means)


#factor(paste("NH4.lm",0:15,",", sep=""))
#factor(paste("NH4.lm",0:15,"summary(NH4.lm", sep=""))

AICctab(NH4.lm1,NH4.lm2,NH4.lm3,NH4.lm4,NH4.lm5,NH4.lm6,NH4.lm7,NH4.lm8,NH4.lm9,NH4.lm10,NH4.lm11,NH4.lm12,NH4.lm13,NH4.lm14,NH4.lm15)

summary.aov(NH4.lm14)
summary.lm(NH4.lm14)
summary(leach.lm14)
```

